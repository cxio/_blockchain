//////////////////////////////////////////////////////////////////////////////
Copyright (c) 2019 - 2024 @cxio/blockchain

    Permission is granted to copy, distribute and/or modify this document
    under the terms of the GNU Free Documentation License, Version 1.3
    or any later version published by the Free Software Foundation;
    with no Invariant Sections, no Front-Cover Texts, and no Back-Cover Texts.
    A copy of the license is included in the section entitled "GNU
    Free Documentation License".
&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&


区块链是区块的集合，区块包含了当前合法并可纳入区块的不定数量的交易。如果有一笔交易被纳入了区块，就相当于该交易被记账了。

区块可以被任意的节点构造出来，其它节点验证其中的交易，如果完全合法，理论上这一区块就可以成为区块链上的新区块。但正因为任意节点都可以创建区块，所以就需要一种机制来决定：谁的区块可以进入主链，也即：谁拥有区块的铸造权。


## 基于历史的证明（PoH: Proof of Historical）

交易ID是交易数据的哈希摘要，拥有随机性，因此我们可以把交易ID用作某种评选因子，评选出哪一位用户可以铸造区块。

交易是任何一位使用区块链的用户都会创建的，拥有普适性，同时，它也是一种历史性数据无法更改，所以十分适合铸造评选的用途。

与传统的PoS权益证明不同，交易ID与交易上的财富无关，不论交易中携带了多少金额，ID都是平等的，没有富者越富的逻辑。唯一增加获选机会的方式是创建更多的交易，但这可能并不是一件真实有效益的事，因为每一笔交易都需要支付手续费。

另外，这种机制会一定程度鼓励交易，而更多的交易和交易费能更好地保证矿工的收益，这是一种良性回馈的逻辑。


### 规则

- 用交易ID与目标区块的ID在作某种计算之后进行**相似性**对比，相似程度越高，则权重越高。
- 目标区块取区块链末端 `-11号` 区块。这是一个动态的逻辑，随着新区块的不断生成，目标区块也在不断改变。
- 参与评选的交易需位于目标区块之前的区块内，这是为了避免哈希塑造作弊。即交易位于 `-10号` 区块之前，这里设计为 `[-11 ~ -100,000]` 的范围（含边界）。
- 上面的范围有结束点，这提供了一种淘汰机制：太过古老的交易被排除，新的交易不断进入，人们可以用脚投票来离开不良的铸造代理商。

为便于描述，有资格参与铸造评选的交易称为「铸凭交易」，作为评比参考的 `-11号` 目标区块称为「评参区块」。

> **哈希塑造**
> 通过向源数据中加入随机无用的数据来塑造其哈希摘要，以使其趋近于想要的结果。


### 哈希相似性

如果将哈希字节序列想象成一条以字节值为纵轴（Y轴），字节序位为横轴（X轴）的曲线，两条曲线的相似度即称之为哈希相似性（*本设计中的定义*）。

铸凭交易ID和评参区块ID是哈希相似性对比的两个源数据，最终的对比算法需要加入一些安全性约束。


#### 铸凭哈希

从交易ID演算过来的哈希称为「铸凭哈希」，加入了在评参区块创建时无法预知，但在评选铸造时已知的信息。这可以避免铸造者对当前区块进行哈希塑造以利于自己的交易ID的作弊行为。该信息称为**X信息**，是从评参区块的下一个区块（后继块）中提取的。

> **注：**
> X信息需要拥有确定性，它不能只是简单地取用后继块的ID，否则就只是把哈希塑造的机会转给了后继块而已。

另外，铸凭哈希应当用签名之后的数据进行计算，这样可以隐藏交易ID本身，避免攻击者寻找和收集那些潜在的高权重者。

> **说明：**
> 下面的伪代码类似Go语言语法，仅用于表意。

```go
// 铸凭哈希算法
//
// 签名源数据
// 这是公开的信息，攻击者可以探查。
// 安全性：
// 增加评参区块ID本身可获得一种交叉关联。
// X信息源于后继块，当前未知，铸造者无法塑造区块ID来有利于自己。
var hashData []byte = Hash256( 铸凭交易ID + X信息 + 评参区块ID )

// 铸造者签名
// 结果是私有的，攻击者无法构造该数据。
var signData []byte = Sign( hashData )

// 铸凭哈希（64字节）
// 攻击者无法走到这一步，因此也无法判断谁是高权重者。
var hashMint []byte = Hash512( signData )
```


#### 基准哈希

由评参区块ID衍生计算而来的哈希，用于与用户的铸凭哈希进行哈希相似性对比。

```go
// 加入铸凭哈希获得关联性制约。
var mintBase []byte = Hash512( 评参区块ID + hashMint )
```


#### 哈希相似性算法

在哈希序列中按4字节为单位取点（X轴）计算点位的值（Y轴），获得一条曲线，两条曲线在Y轴上的差值称为**位差**，各位差绝对值之和即为**相差**。相差越小，则表示两条曲线越相似。

```go
// X轴：按4字节分段取点
// Y轴：上面4字节转整数值
// 位差：Y坐标差值的绝对值
var sum int64
for n:=0; n<16; n++ {
    i := n * 4
    v0 := Uint32( mintBase[i : i+4] )
    v1 := Uint32( hashMint[i : i+4] )
    sum += | v1-v0 |
}
return sum  // 相差：位差之和
```

返回的 **相差** 即用于铸造评选，值小者胜出。


### 最终唯一性

理论上，不同的竞争者可能出现*相差*相等的情形，此时就需要最终唯一性来决定胜负。

这里简单地取铸凭哈希本身来对比，值小者胜出。


### 设计参数

> 铸凭交易的有效范围：`[-11 ~ -100,000]号` 区块，含边界区块本身。<br>
> 哈希相似性对比取 `512位` 哈希长度（64字节），X轴点位值取 `32位` 长度（4字节）。<br>
> 最终唯一性保证采用铸凭哈希本身（`hashMint`）逐字节对比，值小者胜出。<br>



## 铸造委托

用交易ID作铸造评选因子拥有普适性，候选基数庞大，从尽可能大的规模中择优，才能更好地压制潜在的攻击者。这要求普通的用户也尽可能参与进来，但他们通常缺乏相关技能。所以，让普通用户可以委托专业的铸造商行使铸造权十分必要。

因此，在交易的数据结构中我们添加了铸造委托的定义。

```go
[1]  分成定义，1字节长。定义铸造地址和收益地址的分成
[20] 铸造地址，20字节长。可选
[20] 收益地址，20字节长。可选
```
其中：

- 分成定义：配置收益地址的分成百分比（0~100），另外有2个特殊值 0x80 和 0xff。
- 铸造地址：指定铸造者。通常是第三方专业铸造服务商的地址，当然也可以是用户自己的（自己铸造）。
- 收益地址：接收铸造的收益分成。如果是委托第三方铸造，这提供了一个很方便的收款限定。

根据分成值的不同，可以实现多种模式：

1. 值 `0`：不指定收益地址。后续仅有铸造者，收益可发送到任意地址。这是最灵活的委托模式。（1+20）
2. 值 `1-99`： 收益地址的收益占比。后续包含铸造者和收益者，收益的剩余部分可任意处理。（1+20+20）
3. 值 `100`：全部支付到收益地址。后续为铸造者和收益者，这是限制最为严格的模式。（1+20+20）
4. 值 `0x80`：特殊值。后续为收益地址，接收全部收益。铸造者为当前交易的首笔输入源地址。（1+20）
5. 值 `0xff`：特殊值。铸造者同上0x80情形，收益者任意，后续无地址配置。这可能是大多数交易的配置。（1）

> **注：**
> 如果铸造者不接收收益，所有的模式都可以**冷挖矿**。


### 交易头

类似于区块头抽象了区块数据，这里设计了交易头结构，铸造委托的定义即被配置在这里。

交易中的输入和输出部分会分别计算哈希，然后两者合并计算的哈希即为交易体数据的哈希，交易头的哈希即为交易ID。

交易头结构（`85` 字节）：
```go
// 伪代码
TxHeader {
    Version    int32     // 版本
    Timestamp  int64     // 交易时间戳。设定为未来时间可处于链外游离等待
    Scale      uint8     // 收益分成（x/100）
    Minter     Address   // 铸造地址，20字节，可选
    Staker     Address   // 收益地址，20字节，可选
    HashBody   Hash256   // 数据体哈希，Hash(输入摘要+输出摘要)
}
```


### 附：交易体结构

交易体由输入和输出两部分组成。输入部分是对有效 `UTXO`（未花费输出）的引用，由**区块高度**（4字节）、**交易序位**（4字节）和**输出偏移**（2字节）三部分组成，单笔引用长度为10字节。

输入摘要由2部分串接后哈希运算而成：`Hash(首笔输入引用 + Hash (剩余输入引用...))`。其中把首笔交易分离了出来，便于检索验证。

输出部分则稍为复杂，单笔输出包含了**接收者**、**币金数量**、**锁定脚本**等各自独立的部分（详见脚本设计部分）。因为内容较多且长度不定，所以不同的输出会各自计算哈希，最后全部输出按类默克尔树构造出一个根哈希，作为输出的摘要。

> **注记：**
> 已经验证的区块链是安全的，所以实际上交易的解锁数据不必一直存在，它可以在适当的时候被移除。
> 这也是解锁数据不参与交易ID计算的原因。


### 安全性

铸造委托创建了铸造市场化运行的机制，不同的服务商彼此竞争，提供专业的服务，获得用户的委托。委托是自由的，新的委托不断加入，过期的委托不断失效，这就带来了流动性。用户可以选择用脚投票，改变新交易的委托目标。


### 设计参数

> 委托定义在每笔交易里增加了 `1~41字节` 的开销。<br>
> 按分成比例值的不同，可以有多种不同的铸造模式。<br>
> 区块出块时间间隔为固定的 `6分钟`。<br>



## 铸造者的预选与同步

因为评参区块是链末端 `-11号` 区块，所以一个铸造候选者可以提前 `1~10个` 区块时段得知要对比的目标。如果一个节点及时评估并广播自己的铸凭交易，则全网会有充足的时间进行预先沟通。尽量多的参与者加入，可以使得尽可能优质的铸凭交易被发掘出来。


### 择优池

在铸造候选者的预先沟通中，各个节点会收集广播出来的铸凭交易，按权重排序放入一个缓存池，这个缓存池称为 **择优池**。新铸凭交易加入择优池的过程很简单：计算它的权重，如果比池中最差的一个更优，则有序插入并转播，否则忽略。

广播的铸凭交易需要被验证，这由铸造者对铸凭哈希的签名实现（如前）。当出块时间到达时，理论上，择优池中位于前端的铸造者就可以铸造区块并广播了。

> **提示：**<br>
> 在择优池前部成员铸造区块之前，择优池有一个**同步**环节，以此来获得**确定性**。<br>


### 择优池同步

择优池中的成员是动态更新的，为避免刚上线的优质竞争者带来的扰乱（分叉），各节点的择优池应当被提前确定下来（获得确定性），这就需要对择优池进行同步。

在一个新区块成为评参区块（`-11号`）之前，可以有如下分段逻辑：

1. **广播收集**：目标区块被创建后，到它成为 `-9号` 区块前（7个区块时段），与它做相似性对比的铸凭交易可以被广播和收集。
2. **一级同步**：当该区块成为 `-9号` 区块后，择优池的收集和更新结束，进入一级同步阶段。此阶段为补齐不同节点间择优池的差距，耗时1个区块时段。
3. **二级同步**：当该区块成为 `-10号` 区块后，执行二级同步。这是一种确定性同步，同化为授权节点的择优池。用时1个区块时段。
4. **抵达就位**：当该区块成为 `-11号` 区块后，即成为最新时段待创建区块的评比参考目标。

> **注记：**<br>
> 广播收集阶段只有7个区块时段，因为实际上需要等待后继块出来之后才能计算铸凭哈希。<br>
> 区块链初始11个区块的创建没有-11号区块作为参考，这是一个特殊区段。它们有专属的创建规则。<br>


#### 授权节点

择优池大小设计为 `20`，有权同步的节点为择优池中 `后16` 名成员。这基于利益无关性考虑：

*在P2P环境下，时间是一个无法准确的值，系统需要容忍这种模糊性。如果没有限制，高权重的迟到竞争者可以随时把自己加入择优池然后发起同步，因为其高权重，它有可能最终胜选，于是就干扰到了最终的结果，让预先同步失去意义。而且也让同步工作难以按时结束。*

有了这一限制后，排序靠后者没有动力去把迟到的高权重者补入。


#### 一级同步

这一阶段是为了充分补充不同节点收集到的择优池成员，尽可能将所有节点的择优池同化为相同的内容。

发起同步的节点是否有权由如下规则判断：

1. 对方是否在自己的择优池中（不论排名如何）。
2. 对方先提供其择优池前4个成员，以此来证明自己确实属于 **后16** 位成员。

上面的验证合法后，接收剩余的择优池成员并合并，否则忽略。如果是一个新上线的节点，可以先无条件接受几个节点的数据，然后再按上面的规则来处理。


#### 二级同步

通过一级同步之后，全网并不能确保所有节点的择优池数据都相同，也即此时的择优池并没有完全可靠的 **确定性**，因此需要二次同步。

与一级同步不同，此时不再合并择优池数据，而是比较并选取出一个最优集（仅需针对头部**4位**成员权重）。同步者的择优池数据是独立的，也是确定的。

二级同步的成员权利判断与一级同步相同。

> #### 最优集计算
> 针对择优池前4名成员，各自乘以一个系数，合并计算其择优权重（相差），值小者获胜。
> 按第1~4位顺序，系数分别为：`5`、`3`、`2`、`1`，越靠前的权重越高。


### 设计参数

> 择优池容量为 `20名` 候选者。<br>
> 择优池中权重排序在 `4名` 之后的 `16位` 候选者有权发起择优池同步。<br>
> 有权同步的候选者在两级同步中都只有 `1次` 同步的权力。<br>



## 区块铸造

当出块时间将要到达时，理论上择优池中的全部候选者都有权出块，但因为区块竞争的条件很明确，通常只需要前端候选者出块就可以了。


### 择优凭证

区块铸造的权重证明包含了如下几项信息：

- 交易定位信息：区块高度（4字节）、交易序位（4字节）。
- 铸造者公钥。
- 铸造者的签名（如前 `signData`）。
- 权重值（哈希相似性对比中的相差）。

择优凭证就是上面铸造者权重的可验证信息，其中的*权重值*会保存在区块头内，作为前面铸凭哈希计算里的 **X信息**。


### 铸造冗余

区块的铸造者通常就是择优池中的第一名，但网络世界可能存在任何异常，如果第一名候选者正好离线了，区块铸造应当正常进行。所以在现实的运行中，作为一种约定，择优池中的 `前4名` 都会铸造区块并发布。作为转播的简单策略：如果网络中已经存在了高权重且合法的区块，则低权重区块就可以忽略了。

> **注：**
> 如果择优池前4名都没有发布区块（基本上不可能），作为一种异常补救，后续16名成员可以发布区块。
> 而如果后续16位成员都再不发布的话？好吧，，这条链可以死了，没有挽救的必要😂。Sorry...


### 时间截至

区块不能收录未来的交易（按时间戳计算，包含出块时间点），这是一个基本设计。因此铸造者没有理由延时等待更多的交易抵达，新区块通常会在预定的时间开始创建、广播和验证。

区块的广播抵达和区块数据的同步完成不是一个概念，只要可验证的区块证明抵达全网，区块的数据同步就可以稍晚一点。


### 设计参数

> 评参区块之后的后继块里的 `择优凭证` 被用于铸凭哈希源数据里的 `X信息`。<br>
> 铸造者按择优池中的排名决定，但为冗余安全，择优池中 `前4名` 候选者都会打包签发区块。<br>




-------------------------------------------------------------------------------

上一篇：[导读](0.导读.md)<br>
下一篇：[共识模型-端点约定](2.共识模型-端点约定.md)<br>
