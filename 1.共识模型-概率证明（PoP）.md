//////////////////////////////////////////////////////////////////////////////
Copyright (c) 2019 - 2020 @cxio/blockchain

    Permission is granted to copy, distribute and/or modify this document
    under the terms of the GNU Free Documentation License, Version 1.3
    or any later version published by the Free Software Foundation;
    with no Invariant Sections, no Front-Cover Texts, and no Back-Cover Texts.
    A copy of the license is included in the section entitled "GNU
    Free Documentation License".
&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&


区块链是区块的集合，区块包含了当前合法并可纳入区块的不定数量的交易。如果有一笔交易被纳入了区块，就相当于该交易被记账了。

区块可以被任意的端点构造出来，其它端点验证其中的交易，如果完全合法，理论上这一区块就可以成为区块链上的新区块。但正因为任意端点都可以创建区块，所以就需要一种机制来决定：谁的区块可以进入主链，也即：谁拥有区块的铸造权。


## 基于概率的证明（PoP: Proof of Probability）

交易ID是交易数据的哈希摘要，拥有无法预测的随机性，因此我们实际上可以把它用作一种评选因子：评选出哪一位用户可以铸造区块。交易是任何一位使用区块链的用户都会创建的，拥有普适性，同时它也是一种历史性数据，无法更改，所以十分地适合这种用途。

另外，与传统的PoS权益证明不同，用交易ID本身与财富无关，不存在权益证明中富者越富的逻辑。唯一增加获选机会的方式是创建更多的交易，而这与财富数量的关联性并不高（较少的财富也可以创建大量的交易）。

同时，用交易ID来评选铸造权可以鼓励交易，大量的交易费能够保证矿工的收益，这是一个正向回馈的良性逻辑。


### 规则

- 用交易ID与目标区块的ID进行 **哈希相似性** 计算对比，相似程度越高，则权重越高。目标区块取区块链末端 `-11号` 区块。
- 参与评选的交易需位于目标区块之前以避免哈希塑造，因此交易位于 `-10号` 区块之前即可，这里设计为 `[-11 ~ -100,000]` 的范围（含边界）。合法的范围了提供一种淘汰机制：更古老的交易被排除，新的交易不断被加入，人们可以用脚投票来离开不良的铸造代理商。
- 交易头中有一个 **历史标记** 用于绑定本链，参与评选的交易需要是本链的才行。这一要求源于分叉可合并的设计，避免分叉上的交易拥有铸造权。

为便于描述，有资格参与铸造评选的交易可以称为「铸凭交易」，由其交易ID衍生计算出来与目标区块做哈希相似性对比的哈希称为「铸凭哈希」，而作为评比参考的 `-11号` 目标区块下面也可以称为「评考区块」。

> **名词：哈希塑造**
> 通过向源数据中加入随机无用的数据来塑造其哈希摘要，以使其趋近于想要的结果。这需要大量的计算，会导致类似于PoW的竞争。


### 哈希相似性

如果将两个数据的哈希字节序列想象成两条曲线，两条曲线的相似度可称为哈希相似性。

交易ID与评考区块ID只是哈希相似性对比的两个源数据，最终用于对比的两条哈希曲线需要经过计算，加入一些安全性上的约束。


#### 铸凭哈希

由交易ID衍生计算出来，需要加入即时的动态性，以及在评考区块创建时无法预知，但在铸造评选时已知的信息。这可以避免铸造者对区块哈希进行塑造（以趋近于自己已有交易ID）的作弊行为。这样的信息可以从评考区块的下一个区块（**后继块**）中提取，此处暂时称之为 **X信息**。

**X信息** 需要拥有确定性，不能只是简单的取用后继区块的哈希，否则就只是把哈希塑造的机会转给了后继块而已。

另外，铸凭哈希实际上可以用签名数据计算，这样就可以隐藏潜在的高权重但未参与竞争的交易ID，使得攻击者无法主动寻找他们（收集并贿赂他们参与攻击）。

> **注：**
> 以下及之后的代码借鉴了Go语言语法，但皆为伪代码，仅用于表意。

```go
// 签名源数据
var hashData []byte = Hash256( 交易ID + 后继块X信息 )

// 铸造者签名
var signData []byte = Sign( hashData )

// 铸凭哈希（64字节）
var hashUser []byte = Hash512( signData )
```


#### 基准哈希

即由评考区块ID衍生计算出来的哈希，用于与用户的铸凭哈希进行哈希相似性对比。

```go
// 加入铸凭哈希产生联动性约束。
var hashBase []byte = Hash512( 评考区块ID + hashUser )
```


#### 哈希相似性算法

在哈希序列中按4字节为单位取点，计算两条哈希曲线的差值。最终取差值绝对值的和为对比。

```go
// X轴：4字节分段取点
// Y轴：4字节整数取值
// 相位差：两条曲线Y坐标差距取绝对值
var sum int64
for n:=0; n<16; n++ {
    i := n * 4
    v0 := Uint32( hashBase[i : i+4] )
    v1 := Uint32( hashUser[i : i+4] )
    sum += | v1-v0 |
}
return sum  // 相位差和
```

返回的 **相位差和** 即用于铸造评选，值小者胜出。


### 最终唯一性

理论上，不同的竞争者可能出现相位差和相等的情形，此时就需要最终唯一性来决出胜负。

这里设计为简单地取铸凭哈希本身 **逐字节** 对比即可，值小者胜出。


### 设计参数

> 铸凭交易的有效范围：`[-11 ~ -100,000]号` 区块，含边界区块本身。<br>
> 哈希相似性对比取 `512位` 哈希长度（64字节），相位值取 `32位` 长度（4字节）。<br>
> 最终唯一性保证采用铸凭哈希本身（`hashUser`）逐字节对比，值小者胜出。<br>



## 铸造委托

用交易ID作为铸造评选因子有广泛的普适性，概率基数庞大，但这要求无专业技能的普通用户参与进来。显然，专业技能和时间的花费是一个不小的壁垒。没有普通用户的参与，庞大的概率基数没有意义，因此让普通用户委托专业的铸造者行使铸造权十分必要。

为此，在交易的数据结构中添加了「铸造委托」的定义。结构为：**铸造地址(20) + 分成定义(1) + 收益地址(20)**，长度41字节。其中：

- 铸造地址：定义铸造者，负责相关的签名逻辑。这可以是用户自己的地址，也可以是第三方专业铸造服务商提供的地址。
- 分成定义：定义铸造地址与收益地址的分成比例。有效值为：`[0 - 199]` 和 `255`，前者为一个范围。
- 收益地址：接收铸造的收益分成。如果委托第三方铸造，这是一个很有用的值，用户可直接接收到铸造商的收益支付。

根据分成值的不同，实际上出现了三种模式：

1. 值 `0`：    收益地址无收益，全部收益支付到铸造地址。此时收益地址可省略，节省32字节的空间。
2. 值 `255`：  铸造收益全部支付到收益地址，铸造者无收入。可实现铸造与收益的完全分离，即通常所说的 **冷挖矿**。
3. 值 `1-199`：按 `n/200` 的比例支付到收益地址，剩余的支付到铸造地址。这就是外部委托铸造的情形。


### 交易头

类似于区块头抽象了区块数据，这里设计了交易头结构，铸造委托和历史标记就被定义在这里。

交易中的输入和输出部分被分别计算哈希摘要，然后两者合并计算交易体的哈希存入交易头里。交易ID就是交易头数据的哈希摘要。

交易头结构（`85+20` 字节）：
```go
// 伪代码
TxHeader {
    Version    int32     // 版本
    Timestamp  int64     // 交易时间戳。设定为未来时间可处于链外游离等待
    BlockClue  [20]byte  // 历史标记
    Minter     Address   // 铸造地址，20字节
    Scale      uint8     // 收益地址分成（x/200|255）
    Staker     Address   // 收益地址，20字节，可选
    HashBody   Hash256   // 交易数据体哈希，32字节
}
```

#### 附：交易的末端区块与历史标记

本设计中无需工作量逻辑，区块的出块时间间隔为固定的值（如：6分钟）。交易的 **末端区块** 指交易时间戳时间对应的区块链最新已确认区块（即该时间处于新块创建期，刚好可以被收录），`高度 = (交易时间戳 - 创始块时间戳) / 6分钟`。

在交易中嵌入主链上特定历史区块的标记，实现了交易者对主链的认可，这是一种安全性设计，用于排除攻击分叉上的交易的铸造权利。**历史标记** 绑定的目标就是从交易的末端区块算起的 `-11号` 区块，值为区块哈希的前 `20字节`。

> **注：**<br>
> 交易的末端区块与区块链的末端区块是两个不同的概念，后者是一个不断更新的值。<br>
> 因为交易的历史标记会绑定主链，所以实际上就避免了私自挖矿的攻击，因为交易是公开的。<br>


### 安全性

铸造委托创建了铸造市场化运行的机制，不同的钱包服务商彼此竞争，提供专业的服务，获得用户的委托。委托是自由的，新的委托不断加入，过期的委托不断失效，这就带来了流动性。用户可以选择用脚投票，改变新交易的委托目标，从而形成对大型服务商垄断市场的一种约束。

实际上，钱包服务商和接收铸造委托没有必然的关联，作为一种友好，钱包服务商甚至可以让用户自己指定委托目标（铸造服务商）。


### 设计参数

> 委托定义在每笔交易里增加了 `20+1字节` 的固定开销和 `20字节` 的可选开销。<br>
> 分成比例的不同，创建了3种完全不同的铸造安全模式：`0`、`255`、`1-199`。<br>
> 区块出块时间间隔设计为 `6分钟`。没有工作量的不确定性，因此这是一个恒定值。<br>
> 历史标记截取相对于交易时间戳末端 `-11号` 区块的哈希值的前 `20字节` 序列。<br>



## 铸造者的预选与同步

因为哈希相似性的对比是针对区块链末端 `-11号` 评考区块，所以一个铸造者可以提前 `10-1个` 区块时段得知对比的目标。如果一个节点及时评估并发布自己的铸凭交易（广播），则全网有充足的时间进行预先沟通。尽量多的参与者加入，可以使得尽可能优质的铸凭交易被发掘出来。


### 择优池

在铸造候选者的预先沟通中，各个节点会收集广播出来的铸凭交易，按权重排序放入一个缓存池，这个缓存池称为 **择优池**，容量为 `32`。新的铸凭交易加入择优池的过程很简单：计算它的权重，如果比池中最差的一个更优，则有序插入并转播，否则忽略。

广播的铸凭交易需要被验证，这由铸造者对铸凭哈希的签名实现（如前）。当出块时间到达时，择优池中位于前端的铸造者就可以铸造区块并广播了。

> **注记：**<br>
> 择优池的设计是一个必要的策略，可用于发掘铸造者并有序化竞争，同时也约束全网广播的区块数量。


#### 附：铸造者定位

对铸造者的检索验证通过下面的信息实现：

1. 交易所在实际区块的高度（4字节）和交易在其中的序位（4字节）。用于检索交易的区块哈希树校验集，验证交易是否真实存在。获取必要的信息（交易ID和交易头），验证铸造者。
2. 铸造者的公钥和签名数据，用于验证铸造者地址、签名和铸凭哈希的计算。

> **说明：**<br>
> 哈希树校验集指区块交易集构造出的校验树中，与交易直接关联的纵向验证路径上的哈希。因为大规模的交易数据通常由第三方公共服务存储和提供检索，个体终端只保留区块头链，因此这样的验证设计是必要的。<br>
> 铸造者的验证比较简单：1. 对交易头的摘要计算等于目标交易ID。2. 交易头中定义的铸造者与目标相同。<br>


### 避免分区

P2P网络是自由的，任何潜在的铸造者都可能离线，一个实际上拥有最优铸凭交易的用户也可能刚刚上线。如果刚刚上线的铸造者铸造了一个最优区块，但却因为处于出块时间边界而使得区块未能广泛送达，则全网范围内最新区块的评选就可能不一致，这会导致分区情况的发生（分叉）。或者，一个拥有最优铸凭交易的攻击者选择有意地延迟，也可能导致这种情况。

Bitcoin系统中使用最长链作为约束，但本设计是固定的出块时间，所有分叉（如果有）长度都一样，因此需要一种机制来约束主链的成长、竞争和选择。这就是下面择优池的确定性同步设计，以及后面竞争支链部分的纵向评估规则设计。


### 择优池同步

择优池中的成员是动态更新的，为避免刚上线的优质竞争者带来的扰乱，各节点的择优池应当被提前确定下来（获得确定性），这就需要对择优池进行同步。

每一个择优池都是相对于铸造评比的目标区块的，在该区块成为 `-11号` 区块前的各个时段，有如下规划：

1. **广播收集**：目标区块被创建后，到它成为 `-9号` 区块前（7个区块时段，42分钟），与它做相似性对比的铸凭交易可以被广播和收集。
2. **一级同步**：当该区块成为 `-9号` 区块后，择优池的收集和更新结束，进入一级同步阶段。此阶段为补齐不同节点间择优池的差距，为1个区块时段。
3. **二级同步**：当该区块成为 `-10号` 区块后，执行二级同步。这是一种确定性同步，由授权的节点发送自身的择优池信息。用时1个区块时段。
4. **抵达就位**：当该区块成为 `-11号` 区块后，即成为当前时段待创建新区块的评比参考目标。

> **注记：**<br>
> 广播收集阶段只有7个区块时段，因为实际上需要等待后继块出来之后才能计算铸凭哈希。<br>
> 区块链初始11个区块的创建没有-11号区块作为参考，这是一个特殊区段。它们有专属的创建规则。<br>


#### 授权节点

对择优池的同步仅由当前择优池排序中 `后端24名` 成员发起，这基于利益无关性考虑，原因为：

**在P2P环境下，时间是一个无法准确的值，系统需要容忍这种模糊性。如果没有限制，高权重的迟到竞争者可以随时把自己加入择优池然后发起同步，因为其高权重，它有可能最终胜选，于是就干扰到了最终的结果，让预先同步没有意义。另外，这也让同步工作难以正常结束。**

有了这一限制后，排序靠后的有权同步者没有动力去把迟到的高权重者补入。

> **注：**
> 在两级同步中，同步者都只有一次同步的权利。


#### 一级同步

这一阶段是为了充分补充不同节点收集到的择优池成员，尽可能将所有节点的择优池同化为相同内容。

发起同步的节点是否有权，由接收同步的节点根据自己的择优池情况判断：如果对方为自己择优池中 **后24名** 成员，则认可并合并对方提供的数据，否则忽略。


#### 二级同步

通过一级同步之后，全网并不能确保所有节点的择优池数据都相同，也即此时的择优池并没有完全可靠的 **确定性**，因此需要二次同步。

与一级同步不同，此时不再有合并择优池数据的逻辑，而是缓存各个同步者的同步数据，然后比较并选择一个最优集（相差应当很小）。每个同步者的数据都是独立的，最优集只是某个同步者自己的集合，因此此时的择优池就有了确定性。

授权检查与一级同步相同，同步者需要是接收节点自己择优池中的后24名成员之一。最优集衡量可能用集合中全部成员的权重之和来实现。


#### 可靠性

铸凭交易广播和择优池的收集更新时间有8个区块时段，已足够长。在经历了一级同步之后，各个节点的择优池状况应当已经十分相似。确定性同步是由24个节点发起，只要其中有一个是工作并诚实的，就可以让择优池拥有正确的确定性。


### 设计参数

> 择优池容量为 `32名` 候选者。<br>
> 择优池中权重排序在 `8名` 之后的 `24位` 候选者有权签名和发起择优池同步。<br>
> 有权同步的候选者在两级同步中都只有 `1次` 同步的权利。<br>



## 区块铸造

当出块时间将要到达时，理论上择优池中的全部候选者都有权出块，但因为筛选的条件很明确，通常只需要处于前端的候选者出块就可以了。

择优池是一种临时性的集合，主要是为了挖掘出潜在的高权重铸造者。铸造者的权重证明会被保存在当前区块的 `Coinbase` 交易中，当出现分叉时，就可以验证竞争支链上的区块的铸造者及其权重是否真实。

正因为择优池的临时性，当区块已经完成，择优池就消失了。一个攻击者如果运气足够好，他可能能够找到足够权重的铸凭交易来实施攻击（分叉竞争）。为了降低攻击者获得足够权重的能力，我们可以利用择优池真实汇集铸造者的现实，增加 `2-3位` 高权重者的权重证明，这就是 **择优凭证**。


### 择优凭证

区块铸造的权重证明包含了如下几项信息：

- 交易ID（32字节，可选）。
- 交易所在实际区块的高度（4字节），和其ID在该区块中的序位（4字节）。
- 铸造者公钥。
- 铸造者对 `hashData` 的签名（如前 `signData`）。

毫无疑问，应当选取择优池中前几名的权重证明来保存。它们已经存在于择优池中，无需再请求，所以发布者当前是否在线并无影响。具体的设计是这样：

- Coinbase交易中会固定保存择优池 `前2名` 候选者的权重证明，通常他们就是实际的区块铸造者。
- 如果前2名候选者都异常离线不能打包区块，则按择优池内的顺序，选择权重最高候选者打包的区块。此时就需要包含实际铸造者的权重证明。

另外，在择优凭证中的参与者的哈希相似性对比的「相位差和」的平均值会作为 **择优权重** 保存在区块头内，用来评估分叉链段的竞争力。

> **注：**
> 与普通交易类似，签名数据可作为附属数据不参与计算交易ID，因此古老的区块的签名数据可以删除。


### 铸造者和铸造冗余

#### 铸造者

明确前面铸凭哈希计算里的 **X信息**，我们可以选择存放在区块头内的 **择优权重** 来参与计算，同时再加入评考区块ID本身来获得一种交叉关联，并增加数据的随机性。

```go
var hashData []byte = Hash256( 交易ID + 后继块择优权重 + 评考区块ID )
var signData []byte = Sign( hashData )

// 铸凭哈希
var hashUser []byte = Hash512( signData )
// 基准哈希
var hashBase []byte = Hash512( 评考区块ID + hashUser )
```

铸凭哈希与基准哈希的相位差和即用于权重计算，评估出当前区块的铸造者。


#### 铸造冗余

区块的铸造者通常就是择优池中的第一名，但网络世界可能存在任何异常，如果第一名候选者正好离线了，区块铸造应当正常进行。

所以在现实的运行中，作为一种约定，择优池中的 `前4名` 都会铸造区块并发布，为可能的异常留下冗余保证。如果最终不是择优池前2名候选者签发了区块，则Coinbase交易中还需包含该实际签发者的权重证明（但不作为择优凭证）。

区块不能收录未来的交易（按时间戳计算，包含出块时间点），这是一个基本设计，因此铸造者没有理由延时等待更多的交易抵达，新区块通常会在预定的时间开始创建。但区块的创建、广播和验证都需要时间，这里作如下规定：

**新区块的创建和广播可延长至下一区块时段内的前 `3分钟`，之后节点不再接受新的区块。**

区块的广播抵达和区块数据的同步完成不是同一个概念，只要可验证的区块证明抵达全网，区块的数据同步可延续到下一区块时段完整的6分钟。


### 设计参数

> 为了提升抵抗攻击的能力，择优池中 `前2名` 候选者的权重证明被保存在Coinbase交易中。<br>
> 评考区块之后的后继块里的 `择优权重` 被用于铸凭哈希源数据，提供未知性以避免区块哈希塑造的作弊问题<br>
> 铸造者按择优池中的排名决定，但为预防胜选者异常离线，择优池中 `前4名` 候选者都会打包签发区块。这是一种冗余性安全保证。<br>
> 为适应网络可能的拥堵，新区块的广播和验证维持适当宽松的约束：下一区块时段内前 `3分钟` 都可用<br>



-------------------------------------------------------------------------------

上一篇：[导读](0.导读.md)<br>
下一篇：[共识模型-端点约定](2.共识模型-端点约定.md)<br>
