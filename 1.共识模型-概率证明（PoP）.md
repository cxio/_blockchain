//////////////////////////////////////////////////////////////////////////////
Copyright (c) 2019 - 2023 @cxio/blockchain

    Permission is granted to copy, distribute and/or modify this document
    under the terms of the GNU Free Documentation License, Version 1.3
    or any later version published by the Free Software Foundation;
    with no Invariant Sections, no Front-Cover Texts, and no Back-Cover Texts.
    A copy of the license is included in the section entitled "GNU
    Free Documentation License".
&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&


区块链是区块的链式串联集合，区块包含了不定数量的交易。如果有一笔交易被纳入区块，就相当于该交易被正式记账。

在P2P网络里，任何节点都可以验证交易并打包为一个区块。其它节点验证其中的交易，如果完全合法，理论上这一区块就可以成为区块链上的新区块。但因为任意节点都可以创建区块，所以就需要一种机制来决定：谁的区块被认可？也即：谁拥有该区块的铸造权。


## 基于概率的证明（PoP: Proof of Probability）

交易ID是交易数据的哈希摘要，拥有无法预测的随机性，因此我们实际上可以用它作为一种评选因子。交易是任何一位用户都会创建的，拥有普适性，同时它也是一种历史数据，无法更改，所以十分适合于这种用途。

另外，与传统的PoS权益证明不同，交易本身与财富无关，一笔100万元的交易与一笔10元的交易是平等的，因此权益证明中富者越富的逻辑在这里要缓和得多（有钱者可以创建更多的交易来获得优势，但交易费也是一笔成本）。

同时，用交易ID来评选铸造权可以鼓励交易，较多的交易费能保证矿工的收益、有益于网络。这是一个正向回馈的良性逻辑。


### 规则

- 用交易ID与目标区块的ID进行**哈希相似性**对比，相似程度越高，则权重越高。目标区块取区块链末端 `-11号` 区块。
- 参与评选的交易需要位于目标区块之前（更古老）以避免**哈希塑造**作弊。这里设计为一个范围 `[-11 ~ -100,000]`（含边界），更古老的交易会被排除。这是一种淘汰机制：新交易不断加入，旧交易不断离开，人们可以用用脚投票的方式来离开不良的*铸造代理商*。
- 交易数据中有一个**历史标记**，它是 `-11号` 区块ID的局部哈希（相对交易时间戳计算），用于绑定本链。参与评选的交易必须属于本链才行。

为便于描述，定义如下名词解释：

- **评考区块**：作为评比参考的 `-11号` 区块。
- **铸凭交易**：打包在链末端 `[-11 ~ -100,000]` 区块范围内，历史标记正确的交易。它们有资格参与铸造评选。
- **铸凭哈希**：由铸凭交易的ID衍生计算出来，与评考区块做哈希相似性对比的哈希。
- **哈希塑造**：通过向源数据中加入随机无用的数据来塑造其哈希摘要，以趋近于想要的结果。
- **私自挖矿**：拥有一定铸凭交易资源的攻击者悄悄地分叉出一条支链，等待一定时间后才对外公布，试图扰乱公众对主链的认知。


#### 附：历史标记的安全性意义

在开放的环境下，交易对本链的绑定有一个前提：用户知道本链是哪一条。因此私自挖矿的攻击链需要尽早公布出来，以吸引公众对其作为主链的认可。

根据历史标记的目标设定，在分叉之后10个区块内，攻击链可以打包开放环境里的交易，让自己看起来很强大（交易更多）。但在之后，如果它没有开放出来让人看到，拥有原始主链标记的交易就无法再被打包了。人们会清楚地看到，这很可能就是一条攻击链。

在出块时间固定、区块高度无法提前增长的情况下，所有的竞争支链都是等长的。暂不考虑分叉支链的竞争机制，这里唯一可以分辨谁是攻击者的信息，就是历史标记。

一条区块链出现分叉，在竞争选择之后如果依然有人运行失败的那条支链，这其实是一个*社会性*议题。历史标记只能提供必要的依凭，剩下的是用户的自由。


### 哈希相似性

如果将哈希字节序列想象成一条以字节值为纵轴，字节序位为横轴的曲线，两条曲线的相似度即称之为哈希相似性（*本设计中的定义*）。

铸凭交易ID和评考区块ID是哈希相似性对比的两个源数据，最终的对比算法需要加入一些安全性约束。


#### 铸凭哈希

由交易ID衍生计算出来，需要加入即时的动态性，使得在评考区块创建时无法预知。这样才能避免铸造者对区块哈希进行塑造（有利于自己的铸凭资源）的作弊行为。这样的信息可以从评考区块的下一个区块（**后继块**）中提取，此处暂称之为**X信息**。

**X信息**需要拥有确定性，不能只是简单的采用后继区块的哈希，否则后继者也会拥有哈希塑造的机会。

铸凭哈希会采用签名数据计算，这样可以隐藏潜在的高权重但未参与竞争的交易ID，使得攻击者无法主动寻找他们（贿赂他们参与攻击）。

下面的代码借鉴了Go语言语法，但皆为伪代码，仅用于表意。

```go
// 签名源数据
// 安全性：
// 增加评考区块ID本身，来获得一种交叉关联。
// 后继块X信息当前未知，因此铸造者就无法塑造区块ID来有利于自己。
var hashData []byte = Hash( 铸凭交易ID + 后继块X信息 + 评考区块ID )

// 铸造者签名
var signData []byte = Sign( hashData )

// 铸凭哈希（64字节）
var hashMint []byte = Hash512( signData )
```


#### 基准哈希

由评考区块ID衍生计算出来的哈希，用于与用户的铸凭哈希进行哈希相似性对比。

```go
// 加入铸凭哈希产生联动约束。
// 注记：
// 因为每个铸凭哈希都是不同的，所以这里的基准哈希只是一个逻辑，其值并不确定。
var mintBase []byte = Hash512( 评考区块ID + hashMint )
```


#### 哈希相似性计算

在哈希序列中按4字节为单位取点，计算两条哈希曲线在Y轴上的位差，最终取差值绝对值之和（相差）作对比。

```go
// X轴：4字节分段取点
// Y轴：4字节整数取值
// 位差：两条曲线Y坐标差值的绝对值
var sum int64
for n:=0; n<16; n++ {
    i := n * 4
    v0 := Uint32( mintBase[i : i+4] )
    v1 := Uint32( hashMint[i : i+4] )
    sum += | v1-v0 |
}
return sum  // 相差：位差之和
```

返回的**相差**即用于铸造评选，值小者胜出。


### 最终唯一性

理论上，不同的竞争者可能出现*相差*相等的情形，此时就需要最终唯一性来决定胜负。

考虑简单性，这里设计为“两个铸凭哈希本身逐字节对比，值小者胜出”。

> **安全性：**
> 用户构造交易时，虽然最新的10个区块ID已知（它们会逐渐成为评考区块），9个X信息也已知，
> 但由于铸凭交易有效范围的限制，用户塑造自己交易的ID是没有意义的。


### 设计参数

> 铸凭交易的有效范围：`[-11 ~ -100,000]号` 区块，含边界区块本身。<br>
> 哈希相似性对比取 `512位` 哈希长度（64字节），X轴位值取 `32位` 长度（4字节）。<br>
> 最终唯一性保证采用铸凭哈希本身（`hashMint`）逐字节对比，值小者胜出。<br>



## 铸造委托

用交易ID作为铸造评选因子有广泛的普适性，概率基数庞大，但这要求无专业技能的普通用户参与进来。显然，专业技能和时间的花费是一个不小的门槛，而没有普通用户的参与，庞大的概率基数就没有意义。因此让普通用户委托专业的铸造商行使铸造权十分必要。

为此，需要在交易的数据结构中添加了「铸造委托」的定义。结构为：**铸造地址(20) + 分成定义(1) + 收益地址(20)**，其中：

- 铸造地址：指定铸造者，该地址负责签名相关的逻辑。
- 分成定义：定义铸造地址与收益地址的分成比例。有效值为：`[0 - 100]`。
- 收益地址：接收铸造的收益分成。如果是委托第三方铸造，这会很方便。

根据分成值的不同，实际上有三种挖矿模式：

1. 值 `0`：   收益地址无收益，全部收益支付到铸造地址。此时收益地址可省略。
2. 值 `100`： 全部支付到收益地址，铸造者无收入。可实现铸造与收益的完全分离，即所谓的 **冷挖矿**。
3. 值 `1-99`：铸造收益按 `n/100` 的比例支付到收益地址，剩余的归铸造地址。这就是常见的委托第三方铸造的情形。


### 交易头

类似于区块头抽象了区块数据，这里设计了交易头结构，铸造委托和历史标记就被存储在这里。

交易中的输入和输出部分会分别计算哈希，然后两者合并计算交易体的哈希存入交易头。交易ID就是交易头数据的哈希摘要。

交易头结构（`85+20` 字节）：

```go
TxHeader {
    Version    int32     // 版本
    Timestamp  int64     // 交易时间戳。设定为未来时间可处于链外游离等待
    BlockLink  [20]byte  // 主链绑定（历史标记）
    Minter     Address   // 铸造地址，20字节
    Scale      uint8     // 收益地址分成（x/200|255）
    Staker     Address   // 收益地址，20字节，可选
    HashBody   Hash256   // 交易数据体哈希，32字节
}
```


### 附：交易体结构

交易体由输入和输出两部分组成。输入部分是对有效 `UTXO`（未花费输出）的引用，由**区块高度**（4字节）、**交易序位**（4字节）和**输出偏移**（2字节）三部分组成，单笔引用长度为10字节。输入摘要则是各个输入串联后的哈希值。

输出部分则稍为复杂，单笔输出包含了**接收者**、**币金数量**、**锁定脚本**等各自独立的部分（详见脚本设计部分）。因为内容较多且长度不定，所以不同的输出会各自计算哈希，最后全部输出按类默克尔树构造出一个根哈希，作为输出的摘要。

按照默克尔树组织输出数据，可以方便对具体输出（`UTXO`）的验证。这在效率上很重要。

> **注记：**
> 已经验证的区块链是安全的，所以实际上交易的解锁数据不必一直存在，它可以在适当的时候被移除。
> 这也是解锁数据不参与交易ID计算的原因。


### 安全性

铸造委托创建了铸造市场化运行的机制，不同的钱包服务商彼此竞争，提供专业的服务，获得用户的委托。委托是自由的，新的委托不断加入，过期的委托不断失效，这就带来了流动性。用户可以选择用脚投票，改变新交易的委托目标，从而形成对大型服务商垄断市场的一种制约。

实际上，钱包服务商和接收铸造委托没有必然的关联，作为一种友好，钱包服务商甚至应该让用户自己选择委托目标（铸造服务商）。


### 设计参数

> 委托的定义在每笔交易里增加了 `20+1字节` 的固定开销和 `20字节` 的可选开销。<br>
> 按分成比例的不同，实际上出现了3种完全不同的铸造模式（*自负责*、*冷挖矿*、*对外委托*）。<br>
> 出块时间固定，这里设计为 `6分钟`，或许是一个折衷的合适值。<br>
> 历史标记截取末端 `-11号` 区块ID的前 `20字节` 序列。末端相对于*交易时间戳*对应的区块高度（确定性）。<br>



## 铸造者的预选与同步

因为评考区块是链末端 `-11号` 区块，所以一个铸造候选者可以提前 `1~10个` 区块时段得知要对比的目标。如果一个节点及时评估并广播自己的铸凭交易，则全网会有充足的时间进行预先沟通。尽量多的参与者加入，可以使得尽可能优质的铸凭交易被发掘出来。


### 择优池

在铸造候选者的预先沟通中，各个节点会收集广播出来的铸凭交易，按权重排序放入一个缓存池，这个缓存池称为 **择优池**。新铸凭交易加入择优池的过程很简单：计算它的权重，如果比池中最差的一个更优，则有序插入并转播，否则忽略。

广播的铸凭交易需要被验证，这由铸造者对铸凭哈希的签名实现（如前）。当出块时间到达时，理论上，择优池中位于前端的铸造者就可以铸造区块并广播了。

> **提示：**<br>
> 在择优池前部成员铸造区块之前，择优池有一个**同步**环节，以此来获得**确定性**。<br>


### 择优池同步

择优池中的成员是动态更新的，为避免刚上线的优质竞争者带来的扰乱（分叉），各节点的择优池应当被提前确定下来（获得确定性），这就需要对择优池进行同步。

在一个新区块成为评考区块（`-11号`）之前，可以有如下分段逻辑：

1. **广播收集**：目标区块被创建后，到它成为 `-9号` 区块前（7个区块时段），与它做相似性对比的铸凭交易可以被广播和收集。
2. **一级同步**：当该区块成为 `-9号` 区块后，择优池的收集和更新结束，进入一级同步阶段。此阶段为补齐不同节点间择优池的差距，耗时1个区块时段。
3. **二级同步**：当该区块成为 `-10号` 区块后，执行二级同步。这是一种确定性同步，同化为授权节点的择优池。用时1个区块时段。
4. **抵达就位**：当该区块成为 `-11号` 区块后，即成为最新时段待创建区块的评比参考目标。

> **注记：**<br>
> 广播收集阶段只有7个区块时段，因为实际上需要等待后继块出来之后才能计算铸凭哈希。<br>
> 区块链初始11个区块的创建没有-11号区块作为参考，这是一个特殊区段。它们有专属的创建规则。<br>


#### 授权节点

择优池大小设计为 `20`，有权同步的节点为择优池中 `后16` 名成员。这基于利益无关性考虑：

*在P2P环境下，时间是一个无法准确的值，系统需要容忍这种模糊性。如果没有限制，高权重的迟到竞争者可以随时把自己加入择优池然后发起同步，因为其高权重，它有可能最终胜选，于是就干扰到了最终的结果，让预先同步失去意义。而且也让同步工作难以按时结束。*

有了这一限制后，排序靠后者没有动力去把迟到的高权重者补入。


#### 一级同步

这一阶段是为了充分补充不同节点收集到的择优池成员，尽可能将所有节点的择优池同化为相同的内容。

发起同步的节点是否有权，正常情况下由接收者根据自己的择优池情况判断：如果对方为自己择优池中 **后16** 名成员，则并合并对方提供的数据，否则忽略。除非是一个新上线的节点，可以先无条件接受几个节点的数据，然后再按上面的规则来处理。


#### 二级同步

通过一级同步之后，全网并不能确保所有节点的择优池数据都相同，也即此时的择优池并没有完全可靠的 **确定性**，因此需要二次同步。

与一级同步不同，此时不再合并择优池数据，而是比较并选取出一个最优集（仅针对头部**4位**成员权重）。同步者的择优池数据是独立的，也是确定的。

二级同步的权力判断与一级同步相同。


### 设计参数

> 择优池容量为 `20名` 候选者。<br>
> 择优池中权重排序在 `4名` 之后的 `16位` 候选者有权发起择优池同步。<br>
> 有权同步的候选者在两级同步中都只有 `1次` 同步的权力。<br>



## 区块铸造

当出块时间将要到达时，理论上择优池中的全部候选者都有权出块，但因为区块竞争的条件很明确，通常只需要前端候选者出块就可以了。


### 择优凭证

区块铸造的权重证明包含了如下几项信息：

- 交易定位信息：区块高度（4字节）、交易序位（4字节）。
- 铸造者公钥。
- 铸造者的签名（如前 `signData`）。
- 权重值（哈希相似性对比中的相差）。

择优凭证就是上面铸造者权重的可验证信息，其中的*权重值*会保存在区块头内，作为前面铸凭哈希计算里的 **X信息**。


### 铸造冗余

区块的铸造者通常就是择优池中的第一名，但网络世界可能存在任何异常，如果第一名候选者正好离线了，区块铸造应当正常进行。所以在现实的运行中，作为一种约定，择优池中的 `前4名` 都会铸造区块并发布。作为转播的简单策略：如果网络中已经存在了高权重的区块，则低权重区块就可以忽略了。


### 时间截至

区块不能收录未来的交易（按时间戳计算，包含出块时间点），这是一个基本设计。因此铸造者没有理由延时等待更多的交易抵达，新区块通常会在预定的时间开始创建、广播和验证。

区块的广播抵达和区块数据的同步完成不是一个概念，只要可验证的区块证明抵达全网，区块的数据同步就是自由的。


### 设计参数

> 评考区块之后的后继块里的 `择优凭证` 被用于铸凭哈希源数据里的 `X信息`。<br>
> 铸造者按择优池中的排名决定，但为冗余安全，择优池中 `前4名` 候选者都会打包签发区块。<br>



-------------------------------------------------------------------------------

上一篇：[导读](0.导读.md)<br>
下一篇：[共识模型-端点约定](2.共识模型-端点约定.md)<br>
